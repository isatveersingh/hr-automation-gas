<!DOCTYPE html>
<html>

<head>
  <base target="_top" />
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: 40px auto;
      background: #f5f5f5;
      border-radius: 10px;
      border: 1px solid #ccc;
    }

    h1,
    h2 {
      text-align: center;
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    button:disabled {
      background-color: #888;
    }

    #status {
      margin-top: 20px;
      text-align: center;
      font-weight: bold;
    }

    .hidden {
      display: none;
    }

    button .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      margin-left: 8px;
      border: 2px solid #fff;
      border-top: 2px solid transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .optionButtons {
      text-align: center;
      margin: 20px 0;
    }

    .optionButtons button {
      width: 45%;
      margin: 5px;
    }
  </style>
</head>

<body>
  <h1>Sino Services HR Department</h1>
  <h2>Leave Request Portal</h2>

  <!-- Phase 1: Email prompt -->
  <div id="emailSection">
    <label for="emailInput">Enter your work email</label>
    <input type="email" id="emailInput" placeholder="you@company.com" required />
    <button id="loadFormBtn" onclick="loadForm()">Continue</button>
    <div id="emailError" style="color: red; text-align: center;"></div>
  </div>

  <!-- Phase 2: Option buttons for probation -->
  <div id="probationOptions" class="hidden optionButtons">
    <p>Please choose an action:</p>
    <button type="button" id="requestLeaveBtn">Request Leave</button>
    <button type="button" id="probationFeedbackBtn">Provide Probation Feedback</button>
  </div>

  <!-- Phase 3: Full leave form -->
  <form id="leaveForm" class="hidden">
    <label for="empName">Employee Name</label>
    <input type="text" id="empName" name="empName" readonly />
    <input type="hidden" id="empEmail" name="empEmail" />

    <label for="startDate">Start Date</label>
    <input type="date" id="startDate" required />

    <label for="daysCount">How Many Days</label>
    <input type="number" id="daysCount" min="1" required />

    <label for="leaveType">Type of Leave</label>
    <select id="leaveType" required>
      <option value="">Select Leave Type</option>
      <option value="Annual Leave">Annual Leave</option>
      <option value="Sick Leave">Sick Leave</option>
      <option value="Compensatory Days Off">Compensatory Days Off</option>
    </select>

    <label for="responsibleColleague">Responsible Colleague</label>
    <small style="color:gray; font-style:italic;">
      Hold <b>Ctrl</b> (Windows) or <b>Command</b> (Mac) to select multiple colleagues.
    </small>
    <select id="responsibleColleague" multiple></select>

    <label for="teamLead">Approving Team Lead</label>
    <select id="teamLead" required>
      <option value="">Select Team Lead</option>
    </select>

    <label for="vacationType">Type of Vacation</label>
    <select id="vacationType" required>
      <option value="Paid" selected>Paid</option>
      <option value="Unpaid">Unpaid</option>
    </select>

    <button type="submit" id="submitBtn">Submit</button>
  </form>

  <!-- Phase 4: Probation Feedback form -->
  <form id="feedbackForm" class="hidden">
    <h2 style="text-align:center;">Probation Feedback Form</h2>
    <input type="hidden" id="feedbackEmail" name="feedbackEmail" />

    <label for="feedbackFor">For whom are you giving feedback?</label>
    <select id="feedbackFor" name="feedbackFor" required>
      <option value="">Select an option</option>
      <option value="self">Myself</option>
      <option value="colleague">Colleague</option>
    </select>

    <label for="colleagueName">Colleague Name (optional)</label>
    <input type="text" id="colleagueName" name="colleagueName" placeholder="Enter colleague name if applicable" />

    <label for="feedbackText">Your Feedback</label>
    <textarea id="feedbackText" name="feedbackText" rows="5" required></textarea>

    <button type="submit">Submit Feedback</button>
  </form>

  <div id="status"></div>

  <script>
    function loadForm() {
      const email = document.getElementById("emailInput").value.trim();
      const errorDiv = document.getElementById("emailError");
      errorDiv.textContent = "";

      if (!email) {
        errorDiv.textContent = "Please enter a valid email.";
        return;
      }

      const btn = document.getElementById("loadFormBtn");
      btn.disabled = true;
      btn.innerHTML = 'Loading... <span class="spinner"></span>';

      google.script.run
        .withSuccessHandler((data) => {
          btn.disabled = false;
          btn.innerHTML = 'Continue';

          document.getElementById("empEmail").value = data.empEmail;
          document.getElementById("feedbackEmail").value = data.empEmail;

          // If probation is false, show leave form directly
          if (!data.probation) {
            showLeaveForm(data);
          } else {
            // Show probation options buttons
            document.getElementById("emailSection").classList.add("hidden");
            document.getElementById("probationOptions").classList.remove("hidden");

            document.getElementById("requestLeaveBtn").onclick = () => {
              showLeaveForm(data);
              document.getElementById("probationOptions").classList.add("hidden");
            };

            document.getElementById("probationFeedbackBtn").onclick = () => {
              document.getElementById("probationOptions").classList.add("hidden");
              document.getElementById("feedbackForm").classList.remove("hidden");
            };
          }
        })
        .withFailureHandler((err) => {
          errorDiv.textContent = err.message || "Failed to fetch employee data.";
          btn.disabled = false;
        })
        .getEmployeeData(email);
    }

    function showLeaveForm(data) {
      document.getElementById("emailSection").classList.add("hidden");
      document.getElementById("leaveForm").classList.remove("hidden");

      document.getElementById("empName").value = data.empName;
      document.getElementById("empEmail").value = data.empEmail;

      // Populate colleagues
      const colleagueSelect = document.getElementById("responsibleColleague");
      colleagueSelect.innerHTML = "";
      data.colleagues.forEach((col) => {
        const opt = document.createElement("option");
        opt.value = col;
        opt.textContent = col;
        colleagueSelect.appendChild(opt);
      });

      // Populate team leads
      const teamLeadSelect = document.getElementById("teamLead");
      teamLeadSelect.innerHTML = `<option value="">Select Team Lead</option>`;
      data.teamLeads.forEach((lead) => {
        const opt = document.createElement("option");
        opt.value = lead.email;
        opt.textContent = lead.name;
        teamLeadSelect.appendChild(opt);
      });
    }

    // Handle leave form submission
    document.getElementById("leaveForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const btn = document.getElementById("submitBtn");
      btn.disabled = true;
      btn.innerHTML = 'Submitting... <span class="spinner"></span>';

      const formData = {
        empName: document.getElementById("empName").value,
        empEmail: document.getElementById("empEmail").value,
        startDate: document.getElementById("startDate").value,
        daysCount: document.getElementById("daysCount").value,
        leaveType: document.getElementById("leaveType").value,
        responsibleColleague: Array.from(document.getElementById("responsibleColleague").selectedOptions).map(o => o.value).join(","),
        teamLead: document.getElementById("teamLead").value,
        vacationType: document.getElementById("vacationType").value,
      };

      google.script.run
        .withSuccessHandler((data) => {
          btn.disabled = false;
          btn.innerHTML = "Submit";
          document.getElementById("leaveForm").reset();
          if (data.error) {
            document.getElementById("status").textContent = data.error;
            document.getElementById("status").style.color = "red";
          } else {
            document.getElementById("status").textContent = data.message;
            document.getElementById("status").style.color = "green";
          }
        })
        .withFailureHandler((err) => {
          document.getElementById("status").textContent = "Error: " + err.message;
          document.getElementById("status").style.color = "red";
          btn.disabled = false;
          btn.textContent = "Submit";
        })
        .sendAndUpdateALRequest(formData);
    });

    // Handle feedback form submission
    document.getElementById("feedbackForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const submitBtn = this.querySelector("button[type='submit']");
      submitBtn.disabled = true;
      submitBtn.textContent = "Submitting...";

      const feedbackData = {
        empEmail: document.getElementById("feedbackEmail").value,
        feedbackFor: document.getElementById("feedbackFor").value,
        colleagueName: document.getElementById("colleagueName").value,
        feedbackText: document.getElementById("feedbackText").value
      };

      google.script.run
        .withSuccessHandler(() => {
          submitBtn.disabled = false;
          submitBtn.textContent = "Submit Feedback";
          document.getElementById("feedbackForm").reset();
          document.getElementById("status").textContent = "Feedback submitted successfully.";
          document.getElementById("status").style.color = "green";
        })
        .withFailureHandler((err) => {
          submitBtn.disabled = false;
          submitBtn.textContent = "Submit Feedback";
          document.getElementById("status").textContent = "Error: " + err.message;
          document.getElementById("status").style.color = "red";
        })
        .submitProbationFeedback(feedbackData);
    });
  </script>
</body>

</html>
